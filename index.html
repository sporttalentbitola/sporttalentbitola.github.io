<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPORT TALENT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .tab.active { border-color: #ef4444; color: #ef4444; background-color: white; }
        .modal-bg { background-color: rgba(0,0,0,0.6); }
        .modal-content { transition: transform 0.3s ease-out; }
        .loader { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-200">

    <div id="app-container" class="max-w-5xl mx-auto bg-gray-100 min-h-screen shadow-lg">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 sticky top-0 z-20 flex items-center justify-center space-x-4">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 text-center tracking-wider">SPORT TALENT</h1>
        </header>

        <!-- Tab Navigation -->
        <nav class="bg-white shadow-sm sticky top-[80px] md:top-[84px] z-20">
            <div id="tabs" class="flex justify-around border-b border-gray-300">
                <button data-tab="dashboard" class="tab w-full py-3 px-2 text-center font-semibold text-gray-600 border-b-4 border-transparent hover:bg-gray-50 transition">Dashboard</button>
                <button data-tab="players" class="tab w-full py-3 px-2 text-center font-semibold text-gray-600 border-b-4 border-transparent hover:bg-gray-50 transition">Players</button>
                <button data-tab="requests" class="tab w-full py-3 px-2 text-center font-semibold text-gray-600 border-b-4 border-transparent hover:bg-gray-50 transition">Club Requests</button>
                <button data-tab="contacts" class="tab w-full py-3 px-2 text-center font-semibold text-gray-600 border-b-4 border-transparent hover:bg-gray-50 transition">Contacts</button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main id="content" class="p-4 md:p-6">
            <!-- Content for each tab will be injected here -->
        </main>

    </div>

    <!-- Floating "NEW" Button -->
    <button id="newBtn" class="fixed bottom-6 right-6 bg-green-600 text-white rounded-full p-4 shadow-xl hover:bg-green-700 transition transform hover:scale-110 z-30">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
    </button>
    
    <!-- Modals Container -->
    <div id="modalContainer"></div>

    <!-- "NEW" Button Options Modal -->
    <div id="newOptionsModal" class="fixed inset-0 modal-bg flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 space-y-4 w-11/12 max-w-xs">
            <h3 class="text-xl font-semibold text-center text-gray-800">What to add?</h3>
            <button id="addNewPerson" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">New Player / Contact</button>
            <button id="addNewRequest" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700">New Club Request</button>
            <button id="closeNewOptions" class="w-full bg-gray-200 text-gray-800 py-2 mt-4 rounded-lg hover:bg-gray-300">Cancel</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let appState = {
                activeTab: 'dashboard',
                people: [],
                requests: [],
                reminders: [],
                myProfile: {}
            };

            // --- DOM ELEMENTS ---
            const contentEl = document.getElementById('content');
            const tabsContainer = document.getElementById('tabs');
            const newBtn = document.getElementById('newBtn');
            const newOptionsModal = document.getElementById('newOptionsModal');
            const modalContainer = document.getElementById('modalContainer');

            // --- DATA INITIALIZATION ---
            const loadData = () => {
                appState.people = JSON.parse(localStorage.getItem('sportTalentPeople')) || [
                    // --- FULL PLAYER DATABASE ---
                    { id: 'p_dk', profileType: 'Player', firstName: 'Dan', lastName: 'Kucher', position: 'GK', club: 'FK Inhulets', status: 'Active Contract', salaryRange: '5k-10k' },
                    { id: 'p_ap', profileType: 'Player', firstName: 'Anamarija', lastName: 'Prljevic', club: 'ZNK Split', position: 'GK', notes: 'Women Player', salaryRange: '< 5k' },
                    { id: 'p_bs', profileType: 'Player', firstName: 'Boris', lastName: 'Sekulić', position: 'RB', club: 'Górnik Zabrze', status: 'Active Contract', notes: 'Also plays CB', salaryRange: '10k-20k' },
                    { id: 'p_kt', profileType: 'Player', firstName: 'Kristijan', lastName: 'Tasevski', position: 'LB', club: 'Free Agent', status: 'Free Agent', notes: 'Versatile LB/RB/DMF', salaryRange: '< 5k' },
                    { id: 'p_sr', profileType: 'Player', firstName: 'Sava', lastName: 'Radic', position: 'CB', club: 'FK Radnik Surdulica', status: 'Active Contract', salaryRange: '5k-10k' },
                    { id: 'p_mb', profileType: 'Player', firstName: 'Marko', lastName: 'Bakić', position: 'DMF', club: 'OFI Crete', status: 'Active Contract', notes: 'Montenegro NT', salaryRange: '10k-20k' },
                    { id: 'p_nb2', profileType: 'Player', firstName: 'Nemanja', lastName: 'Belaković', position: 'Winger', club: 'FK Radnicki Nis', status: 'Active Contract', salaryRange: '5k-10k' },
                    { id: 'p_bg', profileType: 'Player', firstName: 'Boban', lastName: 'Georgiev', position: 'AMF', club: 'Free Agent', status: 'Free Agent', notes: 'EU Passport', salaryRange: '< 5k' },
                    { id: 'p_mk3', profileType: 'Player', firstName: 'Mario', lastName: 'Krstovski', position: 'ST', club: 'FC Politehnica Iasi', status: 'Active Contract', salaryRange: '10k-20k' },
                    { id: 'p_tm', profileType: 'Player', firstName: 'Tin', lastName: 'Matić', position: 'ST', club: 'NK Celje', status: 'Active Contract', notes: 'Also RW', salaryRange: '20k-50k' },

                    // Contacts
                    { id: 'c1', profileType: 'Coach', firstName: 'Massimiliano', lastName: 'Canzi', club: 'Juventus Women FC - Italy' },
                    { id: 'c3', profileType: 'Sporting Director', firstName: 'Karolis', lastName: 'Skinkys', club: 'Kerala Blasters FC - India' }
                ];

                appState.requests = JSON.parse(localStorage.getItem('sportTalentRequests')) || [
                    { id: 'r_pav', country: 'Italy', club: 'Pavia FC', positions: 'CB, DMF', budget: '€2k-€4k/month', notes: 'Looking for experienced players.' },
                    { id: 'r_pun', country: 'India', club: 'Punjab FC', positions: 'CB, DM, AM, ST, Winger', budget: '80–120K USD net/season' },
                    { id: 'r_haj', country: 'Croatia', club: 'Hajduk Split', positions: 'CB, DM, CM, LW, RW, CF', budget: '€20-25k/month', notes: 'Free or free loan or small transfer' },
                    { id: 'r_ist2', country: 'Croatia', club: 'Istra Pula', positions: 'LB', budget: '€4-6k/month', notes: 'Free, Max 28 years old' }
                ];
                appState.reminders = JSON.parse(localStorage.getItem('sportTalentReminders')) || [
                    { id: 'rem1', text: 'Follow up with Pogoń Szczecin about winger options.', completed: false }
                ];
                appState.myProfile = JSON.parse(localStorage.getItem('sportTalentMyProfile')) || {
                    introMessage: `Dear [Player Name],\n\nMy name is Zoran Veljanovski, a licensed FIFA Agent (ID: 202405-6005). I am writing to you as I have been following your career with great interest and believe I can assist in your professional development.\n\nTo explore a potential collaboration, could you please clarify if you are currently under contract with another agent or agency, and what your ambitions are for the upcoming season?\n\nI am available for a confidential discussion at your convenience.\n\nBest regards,\n\nZoran Veljanovski\nSport Talent\nEmail: sporttalentbitola@gmail.com\nPhone / WhatsApp: +389 75 339 519 | +49 163 789 7703`
                };
            };
            
            const saveData = () => {
                localStorage.setItem('sportTalentPeople', JSON.stringify(appState.people));
                localStorage.setItem('sportTalentRequests', JSON.stringify(appState.requests));
                localStorage.setItem('sportTalentReminders', JSON.stringify(appState.reminders));
                localStorage.setItem('sportTalentMyProfile', JSON.stringify(appState.myProfile));
            };

            // --- GEMINI API CALL ---
            const callGeminiAPI = async (prompt) => { /* ... */ };

            // --- TEMPLATE & RENDERING ---
            const render = () => {
                tabsContainer.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === appState.activeTab));
                switch (appState.activeTab) {
                    case 'dashboard': renderDashboardPage(); break;
                    case 'players': renderPlayersPage(); break;
                    case 'contacts': renderContactsPage(); break;
                    case 'requests': renderRequestsPage(); break;
                }
            };

            const renderDashboardPage = () => {
                const reminders = appState.reminders || [];
                let remindersHtml = reminders.filter(r => !r.completed)
                    .map(r => `<li class="py-2 px-3 bg-yellow-100 border-l-4 border-yellow-400 text-yellow-800 rounded-r-md">${r.text}</li>`).join('');
                if (!remindersHtml) remindersHtml = '<li>No active reminders.</li>';

                const matches = findHotMatches() || [];
                let matchesHtml = matches.map(match => `
                    <div class="py-3 px-4 bg-blue-100 border-l-4 border-blue-400 rounded-r-md">
                        <p class="font-semibold text-blue-800">${match.request.club} is looking for a ${match.request.positions}.</p>
                        <p class="text-blue-700">Potential match: <span class="font-bold">${match.player.firstName} ${match.player.lastName}</span> (${match.player.position})</p>
                    </div>
                `).join('');
                if (!matchesHtml) matchesHtml = '<p>No automatic matches found right now.</p>';
                
                const introMessage = appState.myProfile ? appState.myProfile.introMessage : '';

                contentEl.innerHTML = `
                    <div class="space-y-8">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Reminders</h2>
                            <ul class="space-y-2">${remindersHtml}</ul>
                        </div>
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">Compatible Combinations</h2>
                            <div class="space-y-3">${matchesHtml}</div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6">
                            <h3 class="text-xl font-semibold text-gray-900 mb-3">My Intro Message</h3>
                            <textarea id="introMessage" class="w-full p-2 border rounded-md h-48">${introMessage}</textarea>
                            <div class="mt-4 flex space-x-2">
                                <button id="saveIntroBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Save Message</button>
                                <button id="shareIntroBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700">Share via WhatsApp</button>
                            </div>
                        </div>
                    </div>
                `;
            };

            const renderPlayersPage = () => {
                const players = appState.people.filter(p => p.profileType === 'Player');
                const positionMap = { 'Goalkeepers': ['GK'], 'Defenders': ['CB', 'RB', 'LB'], 'Midfielders': ['DMF', 'AMF', 'Winger', 'CM'], 'Forwards': ['ST', 'CF'] };
                let html = '';
                Object.keys(positionMap).forEach(posGroup => {
                    const playersInGroup = players.filter(p => positionMap[posGroup].includes(p.position)).sort((a, b) => (b.isHighlighted || false) - (a.isHighlighted || false));
                    if (playersInGroup.length > 0) {
                        html += `<h2 class="text-xl font-bold text-gray-700 mt-6 mb-3 border-b-2 border-red-500 pb-2">${posGroup}</h2>`;
                        html += '<div class="space-y-3">';
                        playersInGroup.forEach(player => { html += createPersonCard(player); });
                        html += '</div>';
                    }
                });
                if (html === '') html = '<div class="text-center text-gray-500 p-6 bg-white rounded-lg shadow">No players found.</div>';
                contentEl.innerHTML = html;
            };

            const renderContactsPage = () => {
                const contacts = appState.people.filter(p => p.profileType !== 'Player').sort((a, b) => a.lastName.localeCompare(b.lastName));
                let html = '<div class="space-y-3">';
                if (contacts.length > 0) {
                    contacts.forEach(contact => { html += createPersonCard(contact); });
                } else {
                    html = '<div class="text-center text-gray-500 p-6 bg-white rounded-lg shadow">No contacts found.</div>';
                }
                html += '</div>';
                contentEl.innerHTML = html;
            };

            const renderRequestsPage = () => {
                let html = '<div class="space-y-3">';
                if (appState.requests.length > 0) {
                    appState.requests.forEach(req => { html += createRequestCard(req); });
                } else {
                     html = '<div class="text-center text-gray-500 p-6 bg-white rounded-lg shadow">No club requests found.</div>';
                }
                html += '</div>';
                contentEl.innerHTML = html;
            };
            
            const formatDate = (dateString) => {
                if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}.${month}.${year}`;
            };

            const createPersonCard = (person) => {
                const isPlayer = person.profileType === 'Player';
                const cardBg = isPlayer && person.isHighlighted ? 'bg-yellow-100 border-l-4 border-yellow-400' : 'bg-white';
                let statusHtml = '';
                if (isPlayer) {
                    const statusColor = person.status === 'Free Agent' ? 'bg-green-500' : 'bg-blue-500';
                    statusHtml = `<p class="text-xs text-white mt-2 inline-block px-2 py-0.5 rounded-full ${statusColor}">${person.status}</p>`;
                    if (person.status === 'Active Contract' && person.contractUntil) {
                        const endDate = new Date(person.contractUntil);
                        const sixMonthsFromNow = new Date();
                        sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);
                        const isEndingSoon = endDate < sixMonthsFromNow;
                        const dateColor = isEndingSoon ? 'text-red-600 font-semibold' : 'text-gray-500';
                        const formattedDate = formatDate(person.contractUntil);
                        statusHtml += `<span class="ml-2 text-xs ${dateColor}">(until ${formattedDate})</span>`;
                    }
                } else {
                    statusHtml = `<p class="text-xs bg-gray-500 text-white mt-2 inline-block px-2 py-0.5 rounded-full">${person.profileType}</p>`;
                }
                
                return `
                    <div class="${cardBg} rounded-lg shadow p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">${person.firstName} ${person.lastName}</h3>
                                <p class="text-gray-600">${isPlayer ? person.position : person.profileType} at <span class="font-medium text-gray-800">${person.club || 'N/A'}</span></p>
                                ${statusHtml}
                            </div>
                            <div class="flex items-center space-x-2">
                                ${isPlayer ? `<button class="view-profile-btn p-2 rounded-md bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold text-sm" data-id="${person.id}">View Profile</button>` : ''}
                                <button class="edit-btn p-2 rounded-md hover:bg-gray-200" data-type="person" data-id="${person.id}"><svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path></svg></button>
                                <button class="delete-btn p-2 rounded-md hover:bg-gray-200" data-type="person" data-id="${person.id}"><svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></button>
                            </div>
                        </div>
                    </div>
                `;
            };

            const createRequestCard = (req) => { /* ... */ };
            
            // --- MATCHING LOGIC ---
            const findHotMatches = () => { /* ... */ };

            // --- MODAL HANDLING ---
            const showAiContentModal = (title, contentPromise) => { /* ... */ };
            const showPlayerProfileModal = (player) => { /* ... */ };
            const showPersonModal = (person = null) => {
                const isEdit = person !== null;
                const modalHTML = `
                    <div class="fixed inset-0 modal-bg flex items-center justify-center z-40" id="personModalInstance">
                        <div class="bg-white rounded-lg shadow-xl w-11/12 md:w-1/2 max-w-2xl modal-content transform scale-95" id="personModalContent">
                            <div class="p-6 border-b"><h2 class="text-2xl font-semibold">${isEdit ? 'Edit Person' : 'Add New Person'}</h2></div>
                            <div class="p-6 max-h-[70vh] overflow-y-auto">
                                <form id="personForm" class="space-y-4">
                                    <input type="hidden" id="personId" value="${isEdit ? person.id : ''}">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700">Profile Type</label>
                                        <select id="profileType" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-50" required>
                                            <option>Player</option><option>Coach</option><option>Sporting Director</option><option>Scout</option><option>President</option>
                                        </select>
                                    </div>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div><label class="block text-sm font-medium">First Name*</label><input type="text" id="firstName" class="mt-1 block w-full p-2 border rounded" value="${isEdit ? person.firstName : ''}" required></div>
                                        <div><label class="block text-sm font-medium">Last Name*</label><input type="text" id="lastName" class="mt-1 block w-full p-2 border rounded" value="${isEdit ? person.lastName : ''}" required></div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium">Club*</label>
                                        <input type="text" id="club" placeholder="Club Name FC - Country" class="mt-1 block w-full p-2 border rounded" value="${isEdit ? person.club : ''}">
                                        <div class="flex items-center mt-2">
                                            <input type="checkbox" id="isFreeAgent" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                            <label for="isFreeAgent" class="ml-2 block text-sm text-gray-900">Or check if Free Agent / Without a Club</label>
                                        </div>
                                    </div>
                                    <div id="playerFields" class="space-y-4 border-t pt-4 mt-4">
                                        <h3 class="font-semibold text-lg text-gray-800">Player Details</h3>
                                        <div><label class="block text-sm font-medium">Position*</label><input type="text" id="position" class="mt-1 block w-full p-2 border rounded" value="${isEdit && person.position ? person.position : ''}"></div>
                                        <div><label class="block text-sm font-medium">Status (e.g., Free Agent, €2.5M)</label><input type="text" id="status" class="mt-1 block w-full p-2 border rounded" value="${isEdit && person.status ? person.status : 'Tracking'}"></div>
                                        <div><label class="block text-sm font-medium">Contract End Date</label><input type="date" id="contractUntil" class="mt-1 block w-full p-2 border rounded" value="${isEdit && person.contractUntil ? person.contractUntil : ''}"></div>
                                        <div><label class="block text-sm font-medium">Video Link (YouTube)</label><input type="url" id="videoURL" class="mt-1 block w-full p-2 border rounded" value="${isEdit && person.videoURL ? person.videoURL : ''}"></div>
                                        <div><label class="block text-sm font-medium">CV Link (Transfermarkt)</label><input type="url" id="cvURL" class="mt-1 block w-full p-2 border rounded" value="${isEdit && person.cvURL ? person.cvURL : ''}"></div>
                                        <div class="flex items-center">
                                            <input type="checkbox" id="isHighlighted" class="h-4 w-4 text-yellow-500 border-gray-300 rounded focus:ring-yellow-400">
                                            <label for="isHighlighted" class="ml-2 block text-sm text-gray-900">Highlight this player (add to Hot List)</label>
                                        </div>
                                    </div>
                                </form>
                            </div>
                            <div class="p-4 bg-gray-50 flex justify-end space-x-3">
                                <button type="button" class="close-modal-btn bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                                <button type="submit" form="personForm" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
                            </div>
                        </div>
                    </div>
                `;
                modalContainer.innerHTML = modalHTML;
                
                const profileTypeSelect = document.getElementById('profileType');
                const playerFieldsEl = document.getElementById('playerFields');
                const clubInput = document.getElementById('club');
                const freeAgentCheckbox = document.getElementById('isFreeAgent');
                const highlightedCheckbox = document.getElementById('isHighlighted');
                const freeAgentLabel = document.querySelector('label[for="isFreeAgent"]');

                const toggleFields = () => { 
                    const isPlayer = profileTypeSelect.value === 'Player';
                    playerFieldsEl.style.display = isPlayer ? 'block' : 'none'; 
                    freeAgentLabel.textContent = isPlayer ? 'Or check if Free Agent' : 'Or check if Without a Club';
                };
                
                freeAgentCheckbox.addEventListener('change', () => {
                    const clubValue = profileTypeSelect.value === 'Player' ? 'Free Agent' : 'Without a Club';
                    if (freeAgentCheckbox.checked) {
                        clubInput.value = clubValue;
                        clubInput.disabled = true;
                    } else {
                        clubInput.value = isEdit && person.club !== clubValue ? person.club : '';
                        clubInput.disabled = false;
                    }
                });

                if (isEdit) {
                    profileTypeSelect.value = person.profileType;
                    if (person.club === 'Free Agent' || person.club === 'Without a Club') {
                        freeAgentCheckbox.checked = true;
                        clubInput.disabled = true;
                    }
                    if (person.isHighlighted) {
                        highlightedCheckbox.checked = true;
                    }
                }
                toggleFields();
                profileTypeSelect.addEventListener('change', toggleFields);
                
                setTimeout(() => document.getElementById('personModalContent').classList.remove('scale-95'), 10);
            };
            
            const showRequestModal = (request = null) => { /* ... */ };
            
            // --- EVENT HANDLERS ---
            tabsContainer.addEventListener('click', (e) => { if (e.target.matches('.tab')) { appState.activeTab = e.target.dataset.tab; render(); } });
            contentEl.addEventListener('click', (e) => {
                const btn = e.target.closest('button'); if (!btn) return;
                
                if (btn.id === 'saveIntroBtn') {
                    appState.myProfile.introMessage = document.getElementById('introMessage').value;
                    saveData();
                    alert('Profile message updated!');
                    return;
                }

                if (btn.id === 'shareIntroBtn') {
                    const message = appState.myProfile.introMessage;
                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    return;
                }

                const type = btn.dataset.type; const id = btn.dataset.id;
                if (btn.classList.contains('view-profile-btn')) {
                    const player = appState.people.find(p => p.id === id);
                    if (player) showPlayerProfileModal(player);
                } else if (btn.classList.contains('delete-btn')) {
                    const itemToDelete = type === 'person' ? appState.people.find(p => p.id === id) : appState.requests.find(r => r.id === id);
                    const itemName = type === 'person' ? `${itemToDelete.firstName} ${itemToDelete.lastName}` : itemToDelete.club;
                    if (confirm(`Are you sure you want to delete ${itemName}?`)) {
                        if (type === 'person') appState.people = appState.people.filter(p => p.id !== id);
                        else if (type === 'request') appState.requests = appState.requests.filter(r => r.id !== id);
                        saveData(); render();
                    }
                } else if (btn.classList.contains('edit-btn')) {
                    if (type === 'person') showPersonModal(appState.people.find(p => p.id === id));
                    else if (type === 'request') showRequestModal(appState.requests.find(r => r.id === id));
                } // ... other button handlers ...
            });
            modalContainer.addEventListener('click', (e) => { 
                if (e.target.classList.contains('close-modal-btn')) { 
                    modalContainer.innerHTML = ''; 
                } 
            });
            modalContainer.addEventListener('submit', (e) => {
                e.preventDefault();
                if (e.target.id === 'personForm') {
                    const id = document.getElementById('personId').value;
                    const personData = {
                        id: id || 'p' + Date.now(),
                        profileType: document.getElementById('profileType').value,
                        firstName: document.getElementById('firstName').value,
                        lastName: document.getElementById('lastName').value,
                        club: document.getElementById('club').value,
                        position: document.getElementById('position').value,
                        status: document.getElementById('status').value,
                        contractUntil: document.getElementById('contractUntil').value,
                        videoURL: document.getElementById('videoURL')?.value,
                        cvURL: document.getElementById('cvURL')?.value,
                        isHighlighted: document.getElementById('isHighlighted')?.checked || false,
                    };
                    if (id) { 
                        const index = appState.people.findIndex(p => p.id === id);
                        appState.people[index] = { ...appState.people[index], ...personData };
                    } else { 
                        appState.people.push(personData);
                    }
                    saveData(); render(); modalContainer.innerHTML = '';
                } else if (e.target.id === 'requestForm') {
                    // ... request form submission logic ...
                }
            });
            newBtn.addEventListener('click', () => newOptionsModal.classList.remove('hidden'));
            newOptionsModal.querySelector('#closeNewOptions').addEventListener('click', () => newOptionsModal.classList.add('hidden'));
            newOptionsModal.querySelector('#addNewPerson').addEventListener('click', () => { showPersonModal(); newOptionsModal.classList.add('hidden'); });
            newOptionsModal.querySelector('#addNewRequest').addEventListener('click', () => { showRequestModal(); newOptionsModal.classList.add('hidden'); });

            // --- INITIALIZATION ---
            loadData();
            render();
        });
    </script>
</body>
</html>
