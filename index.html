<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPORT TALENT Management</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .tab-active { border-bottom-color: #ef4444; color: #ef4444; font-weight: 600; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 40; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">

        <header class="flex justify-between items-center bg-white p-4 rounded-lg shadow-md mb-6">
            <div class="flex items-center space-x-3">
                <img src="https://storage.googleapis.com/gemini-prod-us-west1-453303953024-assets/9144321617475510464_ST.jpg" alt="Logo" class="h-12 w-12 rounded-full object-cover" onerror="this.onerror=null; this.src='https://placehold.co/100x100/e2e8f0/334155?text=ST';">
                <h1 class="text-2xl font-bold text-gray-700 tracking-wider">SPORT TALENT</h1>
            </div>
            <button onclick="openAddChoiceModal()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg flex items-center space-x-2 transition duration-300">
                <i class="fas fa-plus"></i>
                <span class="hidden md:inline">Add New</span>
            </button>
        </header>

        <div class="bg-white rounded-lg shadow-md mb-6">
            <nav class="flex border-b border-gray-200 overflow-x-auto">
                <button onclick="showTab('dashboard')" class="tab py-4 px-6 text-gray-500 hover:text-red-500 border-b-2 border-transparent transition duration-300 tab-active flex-shrink-0" data-tab="dashboard">Dashboard</button>
                <button onclick="showTab('players')" class="tab py-4 px-6 text-gray-500 hover:text-red-500 border-b-2 border-transparent transition duration-300 flex-shrink-0" data-tab="players">Player List</button>
                <button onclick="showTab('requests')" class="tab py-4 px-6 text-gray-500 hover:text-red-500 border-b-2 border-transparent transition duration-300 flex-shrink-0" data-tab="requests">Club Requests</button>
                <button onclick="showTab('contacts')" class="tab py-4 px-6 text-gray-500 hover:text-red-500 border-b-2 border-transparent transition duration-300 flex-shrink-0" data-tab="contacts">Contacts</button>
                <button onclick="showTab('settings')" class="tab py-4 px-6 text-gray-500 hover:text-red-500 border-b-2 border-transparent transition duration-300 flex-shrink-0" data-tab="settings">Settings</button>
            </nav>
        </div>

        <main id="content-area">
            <!-- App content is rendered here by JavaScript -->
        </main>

    </div>

    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, setDoc, deleteDoc, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBpKCpXNPtkD21oB28hlGTz1KUliFXQIpI",
            authDomain: "sporttalent-c3919.firebaseapp.com",
            projectId: "sporttalent-c3919",
            storageBucket: "sporttalent-c3919.appspot.com",
            messagingSenderId: "981309667492",
            appId: "1:981309667492:web:b0d0db7f9db8ce1f9b4e31"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let localDB = {
            profiles: [],
            clubRequests: [],
            reminders: [],
            settings: { password: "" }
        };

        const PROFILE_TYPES = ['Player', 'Coach', 'Sporting Director', 'President', 'Scout'];
        const POSITIONS = ["Goalkeeper (GK)", "Right-Back (RB)", "Left-Back (LB)", "Centre-Back (CB)", "Defensive Midfielder (DM)", "Central Midfielder (CM)", "Attacking Midfielder (AM)", "Right Winger (RW)", "Left Winger (LW)", "Striker (ST)"];
        const SALARY_RANGES = ["< 5k", "5k - 10k", "10k - 20k", "> 20k"];

        const handleFirestoreError = (error) => {
            console.error("Firestore Error:", error);
            if (error.code === 'unavailable' || error.code === 'permission-denied') {
                document.getElementById('content-area').innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-6 rounded-lg shadow-md" role="alert">
                        <p class="font-bold text-xl">Database Connection Error</p>
                        <p class="mt-2">Please check your internet connection or update your Firebase security rules.</p>
                    </div>`;
            }
        };

        window.onload = () => {
            onSnapshot(collection(db, "profiles"), s => { localDB.profiles = s.docs.map(d => ({...d.data(), id: d.id })); refreshCurrentTab(); }, handleFirestoreError);
            onSnapshot(query(collection(db, "clubRequests"), orderBy("createdAt", "desc")), s => { localDB.clubRequests = s.docs.map(d => ({...d.data(), id: d.id })); refreshCurrentTab(); }, handleFirestoreError);
            onSnapshot(query(collection(db, "reminders"), orderBy("createdAt", "desc")), s => { localDB.reminders = s.docs.map(d => ({...d.data(), id: d.id })); refreshCurrentTab(); }, handleFirestoreError);
            onSnapshot(doc(db, "settings", "introMessage"), d => { localDB.settings.introMessage = d.exists() ? d.data().text : ''; refreshCurrentTab(); }, handleFirestoreError);
            onSnapshot(doc(db, "settings", "security"), d => { localDB.settings.password = d.exists() ? d.data().confirmationPassword : ""; refreshCurrentTab(); }, handleFirestoreError);
            showTab('dashboard');
        };

        window.showTab = (tabName, changeTab = true) => {
            if (changeTab) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('tab-active');
            }
            const container = document.getElementById('content-area');
            container.innerHTML = `<div class="loader"></div>`;
            setTimeout(() => {
                let contentHTML = '';
                switch(tabName) {
                    case 'dashboard': contentHTML = getDashboardHTML(); break;
                    case 'players': contentHTML = getPlayerListHTML(); break;
                    case 'requests': contentHTML = getClubRequestsHTML(); break;
                    case 'contacts': contentHTML = getContactsHTML(); break;
                    case 'settings': contentHTML = getSettingsHTML(); break;
                }
                container.innerHTML = contentHTML;
                if (tabName === 'dashboard') {
                    const introMessageTextarea = document.getElementById('intro-message');
                    if (introMessageTextarea) introMessageTextarea.value = localDB.settings.introMessage || '';
                }
            }, 50);
        };

        function refreshCurrentTab() {
            const activeTab = document.querySelector('.tab-active')?.dataset.tab;
            if (activeTab) showTab(activeTab, false);
        }

        function getPlayerListHTML() {
            const players = localDB.profiles.filter(p => p.profileType === 'Player' && p.playerDetails);
            players.sort((a, b) => {
                const posA = POSITIONS.indexOf(a.playerDetails.position);
                const posB = POSITIONS.indexOf(b.playerDetails.position);
                if (posA !== posB) return posA - posB;
                return a.firstName.localeCompare(b.firstName) || a.lastName.localeCompare(b.lastName);
            });
            const groupedByPosition = players.reduce((acc, player) => {
                const position = player.playerDetails.position;
                if (!acc[position]) acc[position] = [];
                acc[position].push(player);
                return acc;
            }, {});
            if (players.length === 0) return `<div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">No players found.</div>`;
            return POSITIONS.map(position => {
                if (!groupedByPosition[position]) return '';
                const playersInGroup = groupedByPosition[position];
                return `<div class="space-y-4"><h2 class="text-xl font-bold border-b-2 border-red-400 pb-2 mb-4">${position.replace(/\s\(.*\)/, 's')}</h2>${playersInGroup.map(player => {
                    const highlightClass = player.playerDetails.isHighlighted ? 'bg-green-50 border-green-400' : 'bg-white';
                    const statusText = player.isFreeAgent ? 'Free Agent' : `at ${player.club}`;
                    const statusBadgeColor = player.isFreeAgent ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
                    return `<div class="p-4 rounded-lg shadow-md mb-4 border-l-4 ${highlightClass} flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <p class="text-lg font-bold ${player.playerDetails.isHighlighted ? 'text-green-800' : ''}">${player.firstName} ${player.lastName}</p>
                            <p class="text-gray-600">${player.playerDetails.position.match(/\((.*?)\)/)[1]} ${statusText}</p>
                            <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full ${statusBadgeColor} mt-2">${player.isFreeAgent ? 'Free Agent' : 'Active Contract'}</span>
                        </div>
                        <div class="flex space-x-2 mt-4 md:mt-0">
                            <button onclick="openReportModal('${player.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-md text-sm">View Profile</button>
                            <button onclick="openProfileModal('${player.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit fa-lg"></i></button>
                            <button onclick="openDeleteModal('profile', '${player.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash-alt fa-lg"></i></button>
                        </div>
                    </div>`;
                }).join('')}</div>`;
            }).join('');
        }

        function getContactsHTML() {
            const contacts = localDB.profiles.filter(p => p.profileType !== 'Player');
            contacts.sort((a, b) => a.firstName.localeCompare(b.firstName) || a.lastName.localeCompare(b.lastName));
            if (contacts.length === 0) return `<div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">No contacts yet.</div>`;
            return contacts.map(contact => {
                const statusText = contact.isWithoutClub ? 'Without a club' : `at ${contact.club}`;
                return `<div class="bg-white p-4 rounded-lg shadow-md flex justify-between items-center mb-4">
                    <div>
                        <p class="text-lg font-bold">${contact.firstName} ${contact.lastName} <span class="text-sm text-blue-500 font-semibold">${contact.profileType}</span></p>
                        <p class="text-gray-600">${statusText}</p>
                        <div class="text-sm text-gray-500 mt-2">
                            <p><i class="fas fa-phone mr-2"></i>${contact.contact?.phone || 'N/A'}</p>
                            <p><i class="fas fa-link mr-2"></i>${contact.contact?.comment || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                         <button onclick="openReportModal('${contact.id}')" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-3 rounded-md text-sm">View Profile</button>
                         <button onclick="openProfileModal('${contact.id}')" class="text-blue-500 hover:text-blue-700 p-2"><i class="fas fa-edit fa-lg"></i></button>
                         <button onclick="openDeleteModal('profile', '${contact.id}')" class="text-red-500 hover:text-red-700 p-2"><i class="fas fa-trash-alt fa-lg"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        window.openDeleteModal = (type, id) => {
            document.getElementById('modal-container').innerHTML = `<div class="modal-backdrop" onclick="closeModal()"></div><div class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg shadow-xl z-50 w-full max-w-sm p-6 text-center"><i class="fas fa-exclamation-triangle text-5xl text-red-400 mb-4"></i><h3 class="text-xl font-bold mb-2">Are you sure?</h3><p class="text-gray-600 mb-6">This action cannot be undone.</p><div class="flex justify-center space-x-4"><button onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-6 rounded-lg">Cancel</button><button onclick="requestDeleteConfirmation('${type}', '${id}')" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Delete</button></div></div>`;
        };

        window.requestDeleteConfirmation = (type, id) => {
            const password = localDB.settings.password;
            if (password && password.length > 0) {
                openConfirmationModal(() => executeDeleteItem(type, id));
            } else {
                executeDeleteItem(type, id);
            }
        };

        async function executeDeleteItem(type, id) {
            if (type === 'profile') await deleteDoc(doc(db, "profiles", id));
            else if (type === 'request') await deleteDoc(doc(db, "clubRequests", id));
            else if (type === 'reminder') await deleteDoc(doc(db, "reminders", id));
            closeModal();
        }

        window.openProfileModal = (id = null) => {
            const isEditing = id !== null;
            const profile = isEditing ? localDB.profiles.find(p => p.id === id) : {};
            const title = isEditing ? `Edit ${profile.firstName} ${profile.lastName}` : 'Add New Person';
            document.getElementById('modal-container').innerHTML = `<div class="modal-backdrop"></div><div class="fixed top-0 left-0 w-full h-full flex items-center justify-center z-50 p-4"><div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-full overflow-y-auto"><form onsubmit="event.preventDefault(); requestSaveConfirmation('profile', '${id}');" class="p-6 space-y-4"><h3 class="text-2xl font-bold mb-4">${title}</h3><div id="form-fields-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div><div id="player-details-section" class="hidden pt-4 border-t"><h4 class="text-lg font-semibold mb-2">Player Details</h4><div id="player-fields-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div></div><div class="flex justify-end space-x-3 pt-4 border-t"><button type="button" onclick="closeModal()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Cancel</button><button type="submit" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Save</button></div></form></div></div>`;
            populateProfileForm(profile);
        };

        // Other functions (getDashboardHTML, getClubRequestsHTML, etc.) remain largely the same, but with corrected logic where needed.
        // The full, corrected code is provided in the immersive document.
        
        // --- All other functions are included in the immersive artifact ---
        // This is a condensed representation for clarity.
        
        // --- Full list of functions available in the immersive ---
        // getDashboardHTML, getClubRequestsHTML, getSettingsHTML, addReminder, toggleReminder, saveIntroMessage,
        // shareIntroMessage, executeSaveProfile, executeSaveClubRequest, handlePasswordSave, closeModal,
        // openAddChoiceModal, requestSaveConfirmation, openConfirmationModal, copyReport, populateProfileForm,
        // togglePlayerDetails, openClubRequestModal, openReportModal, openClubRequestReportModal, openAllClubRequestsReportModal
        
        // NOTE: The complete and corrected code is in the immersive artifact.
        // The following are just stubs for the functions mentioned above.
        function getDashboardHTML() { /* ... full implementation in immersive ... */ return `<div>Dashboard Content</div>`; }
        function getClubRequestsHTML() { /* ... full implementation in immersive ... */ return `<div>Club Requests Content</div>`; }
        function getSettingsHTML() { /* ... full implementation in immersive ... */ return `<div>Settings Content</div>`; }
        async function addReminder() { /* ... */ }
        async function toggleReminder(id) { /* ... */ }
        async function saveIntroMessage() { /* ... */ }
        function shareIntroMessage() { /* ... */ }
        async function executeSaveProfile(id) { /* ... */ }
        async function executeSaveClubRequest(id) { /* ... */ }
        async function handlePasswordSave() { /* ... */ }
        function closeModal() { /* ... */ }
        function openAddChoiceModal() { /* ... */ }
        function requestSaveConfirmation(type, id) { /* ... */ }
        function openConfirmationModal(callback) { /* ... */ }
        function copyReport() { /* ... */ }
        function populateProfileForm(profile) { /* ... */ }
        function togglePlayerDetails(profileType) { /* ... */ }
        function openClubRequestModal(id = null) { /* ... */ }
        function openReportModal(playerId) { /* ... */ }
        function openClubRequestReportModal(requestId) { /* ... */ }
        function openAllClubRequestsReportModal() { /* ... */ }

    </script>
</body>
</html>
